---
title: Testing Opal Integration
layout: page
nav_exclude: true
---

<div>
<textarea id="code" cols="100" rows="20" style="font-family: monospace;">
SAMPLING_FREQUENCY=44100
FREQUENCY=440

in_cycle = 0
samples = (0.5 * SAMPLING_FREQUENCY).times.map do
  period = SAMPLING_FREQUENCY / FREQUENCY.to_f
  output = in_cycle > 0.5 ? -1.0 : 1.0
  in_cycle = (in_cycle + (1.0 / period)) % 1.0
  output
end
samples
</textarea>
</div>
<div>
  <canvas id="canvas" width="1200" height="200" style="border: 1px solid black;"></canvas>
</div>


<button id="run-button">RUN</button>



<script type="text/javascript">
  
  function drawInCanvas(selector, data) {
    const canvas = document.querySelector(selector)
    const ctx = canvas.getContext('2d')
    ctx.clearRect(0, 0, canvas.width, canvas.height)
    const perStep = canvas.width / data.length
    const height = canvas.height
    ctx.strokeStyle = "#000"
    ctx.strokeWidth = 2
    ctx.beginPath()
    ctx.moveTo(0, height / 2)
    data.forEach((d, x) => ctx.lineTo(perStep * x, ((d + 1) / 2 * height)))
    ctx.stroke()
  }

  document.getElementById('run-button').onclick = function(e) {
    e.preventDefault()
    const code = document.getElementById('code').value
    console.log(code)
    const evaluated = Opal.eval(code)
    
    const context = new AudioContext()
    const buffer = context.createBuffer(1, evaluated.length, 44100)
    const data = buffer.getChannelData(0)
    evaluated.forEach((w, i) => data[i] = w)

    const samplePlayer = context.createBufferSource()
    samplePlayer.connect(context.destination)
    samplePlayer.buffer = buffer
    samplePlayer.start()
    drawInCanvas('#canvas', evaluated)

  }


</script>